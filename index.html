<script>
const playerEl = document.getElementById('player');

let images = [];
let current = 0;
let playTimer = null;
let slideIntervalSeconds = DEFAULT_TRANSITION;
let fadeDuration = 1;
let pollTimer = null;

async function loadConfig() {
  try {
    const r = await fetch(JSON_URL);
    if (!r.ok) throw new Error('HTTP ' + r.status);
    const data = await r.json();
    images = Array.isArray(data.images) ? data.images : [];
    slideIntervalSeconds = Number.isFinite(data.transition) ? data.transition : DEFAULT_TRANSITION;
    fadeDuration = Math.min(2, Math.max(0.2, slideIntervalSeconds * 0.12));
    document.documentElement.style.setProperty('--fade', fadeDuration + 's');
    current = 0;
    stopSlideshow();
    renderSlides();
    startSlideshow();
  } catch (e) {
    console.error('Error loading config', e);
    images = [];
    renderSlides();
  }
}

function renderSlides() {
  playerEl.innerHTML = '';
  if (images.length === 0) {
    const msg = document.createElement('div');
    msg.style.color = '#ddd';
    msg.style.padding = '20px';
    msg.textContent = 'No images found.';
    playerEl.appendChild(msg);
    return;
  }

  images.forEach((url, i) => {
    const slide = document.createElement('div');
    slide.className = 'slide' + (i === 0 ? ' visible' : '');
    const img = document.createElement('img');
    img.src = url;
    img.alt = 'photo ' + (i + 1);
    img.onerror = () => { img.style.display = 'none'; };
    slide.appendChild(img);
    playerEl.appendChild(slide);
  });
}

function startSlideshow() {
  if (images.length <= 1) return;
  playTimer = setInterval(() => {
    const slides = Array.from(document.querySelectorAll('.slide'));
    slides[current]?.classList.remove('visible');
    current = (current + 1) % slides.length;
    slides[current]?.classList.add('visible');
  }, Math.max(1000, Math.round(slideIntervalSeconds * 1000)));
}

function stopSlideshow() {
  if (playTimer) { clearInterval(playTimer); playTimer = null; }
}

function startPoll() {
  if (pollTimer) clearInterval(pollTimer);
  pollTimer = setInterval(loadConfig, POLL_INTERVAL);
}

// initialize
loadConfig();
startPoll();
</script>
